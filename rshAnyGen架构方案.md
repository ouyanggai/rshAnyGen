# å¼€æº Agent ç³»ç»Ÿæ¶æ„è®¾è®¡æ–‡æ¡£ï¼ˆåœ¨çº¿æ¨¡å‹ç‰ˆï¼‰

> **é¡¹ç›®ç›®æ ‡**ï¼šæ„å»ºä¸€ä¸ªæ¨¡å—åŒ–çš„ã€æ”¯æŒ MCP/Skills/è”ç½‘æœç´¢çš„ä¸­æ–‡ Agent ç³»ç»Ÿï¼Œä½¿ç”¨åœ¨çº¿ LLM APIï¼Œå¼€æº UIï¼Œæœ€ä¼˜ RAG èƒ½åŠ›

---

## ä¸€ã€ç³»ç»Ÿæ¶æ„æ€»è§ˆ

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                         ç”¨æˆ·ç•Œé¢å±‚                                â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚          Open WebUI (Vue3 + Tailwind)                   â”‚   â”‚
â”‚  â”‚  - å¯¹è¯çª—å£  - å·¥å…·æˆæƒå¼¹çª—  - å¼•ç”¨å¡ç‰‡  - ä¼šè¯ç®¡ç†      â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                           â”‚ WebSocket / HTTP
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                      API ç½‘å…³ & ä¼šè¯å±‚                            â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚  FastAPI Gateway                                        â”‚   â”‚
â”‚  â”‚  - ä¼šè¯ç®¡ç† (Redis)  - æƒé™æ§åˆ¶  - é€Ÿç‡é™åˆ¶              â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                           â”‚
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    Agent ç¼–æ’å±‚ (æ ¸å¿ƒ)                            â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚              LangGraph Orchestrator                     â”‚   â”‚
â”‚  â”‚                                                         â”‚   â”‚
â”‚  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”              â”‚   â”‚
â”‚  â”‚  â”‚æ„å›¾è¯†åˆ«   â”‚â”€â†’â”‚è·¯ç”±å†³ç­–   â”‚â”€â†’â”‚æ‰§è¡Œè®¡åˆ’   â”‚              â”‚   â”‚
â”‚  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜              â”‚   â”‚
â”‚  â”‚       â”‚              â”‚              â”‚                   â”‚   â”‚
â”‚  â”‚       â–¼              â–¼              â–¼                   â”‚   â”‚
â”‚  â”‚  éœ€è¦æœç´¢?      éœ€è¦çŸ¥è¯†åº“?     éœ€è¦å·¥å…·?                  â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
          â”‚               â”‚               â”‚
    â”Œâ”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”   â”Œâ”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”   â”Œâ”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”
    â”‚ æœç´¢åˆ†æ”¯   â”‚   â”‚ RAG åˆ†æ”¯  â”‚   â”‚ å·¥å…·åˆ†æ”¯   â”‚
    â””â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”˜   â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”˜   â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”˜
          â”‚               â”‚               â”‚
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                     èƒ½åŠ›å±‚ (Skills & MCP)                        â”‚
â”‚                                                                 â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚ Skills Registryâ”‚  â”‚  MCP Manager   â”‚  â”‚  Tool Executor   â”‚   â”‚
â”‚  â”‚  (æŠ€èƒ½ä»“åº“)    â”‚  â”‚  (åè®®ç®¡ç†)     â”‚  â”‚  (æ‰§è¡Œå™¨)         â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”‚          â”‚                   â”‚                   â”‚              â”‚
â”‚          â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜              â”‚
â”‚                              â”‚                                  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                               â”‚
         â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
         â”‚                     â”‚                     â”‚
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  MCP Server 1    â”‚  â”‚  MCP Server 2    â”‚  â”‚  MCP Server 3    â”‚
â”‚  (ç™¾åº¦æœç´¢)       â”‚  â”‚  (çŸ¥è¯†åº“è®¿é—®)     â”‚  â”‚  (ä¸šåŠ¡å·¥å…·)       â”‚
â”‚                  â”‚  â”‚                  â”‚  â”‚                  â”‚
â”‚  - search()      â”‚  â”‚  - query_kb()    â”‚  â”‚  - execute()     â”‚
â”‚  - fetch_page()  â”‚  â”‚  - list_docs()   â”‚  â”‚  - ...           â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                        RAG å¤„ç†ç®¡çº¿                               â”‚
â”‚                                                                 â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚æ–‡æ¡£   â”‚â”€â†’â”‚åˆ†å—   â”‚â”€â†’â”‚åµŒå…¥   â”‚â”€â†’â”‚ç´¢å¼•   â”‚â”€â†’â”‚æ£€ç´¢   â”‚â”€â†’â”‚é‡æ’   â”‚   â”‚
â”‚  â”‚åŠ è½½   â”‚  â”‚(ä¸­æ–‡) â”‚  â”‚(API) â”‚  â”‚(Milvusâ”‚  â”‚(Hybridâ”‚  â”‚(API) â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”‚                                                                 â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                       å¤–éƒ¨æœåŠ¡å±‚                                  â”‚
â”‚                                                                 â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚ LLM API    â”‚  â”‚ Embed API  â”‚  â”‚ Rerank API â”‚  â”‚ Vector DBâ”‚  â”‚
â”‚  â”‚ (é€šä¹‰åƒé—®)  â”‚  â”‚ (Cohere/  â”‚  â”‚ (Cohere/  â”‚  â”‚ (Milvus) â”‚  â”‚
â”‚  â”‚            â”‚  â”‚  Jina)    â”‚  â”‚  Jina)    â”‚  â”‚          â”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## äºŒã€æ ¸å¿ƒæ¨¡å—è¯¦ç»†è®¾è®¡

### 2.1 ç”¨æˆ·ç•Œé¢å±‚ (apps/web-ui)

**æŠ€æœ¯é€‰å‹**ï¼šåŸºäº **Open WebUI** äºŒæ¬¡å¼€å‘

**æ ¸å¿ƒåŠŸèƒ½æ¨¡å—**ï¼š

```
web-ui/
â”œâ”€â”€ src/
â”‚   â”œâ”€â”€ components/
â”‚   â”‚   â”œâ”€â”€ ChatWindow.vue           # ä¸»å¯¹è¯çª—å£
â”‚   â”‚   â”œâ”€â”€ MessageBubble.vue        # æ¶ˆæ¯æ°”æ³¡ï¼ˆæ”¯æŒå¼•ç”¨å¡ç‰‡ï¼‰
â”‚   â”‚   â”œâ”€â”€ ToolConsentDialog.vue    # å·¥å…·æˆæƒç¡®è®¤å¼¹çª— â­
â”‚   â”‚   â”œâ”€â”€ CitationCard.vue         # RAG å¼•ç”¨æ¥æºå¡ç‰‡ â­
â”‚   â”‚   â”œâ”€â”€ SkillManager.vue         # æŠ€èƒ½å¯ç”¨/ç¦ç”¨ç®¡ç† â­
â”‚   â”‚   â””â”€â”€ SessionList.vue          # ä¼šè¯å†å²åˆ—è¡¨
â”‚   â”œâ”€â”€ stores/
â”‚   â”‚   â”œâ”€â”€ chatStore.ts             # ä¼šè¯çŠ¶æ€ç®¡ç†
â”‚   â”‚   â”œâ”€â”€ skillStore.ts            # æŠ€èƒ½é…ç½®çŠ¶æ€ â­
â”‚   â”‚   â””â”€â”€ authStore.ts             # ç”¨æˆ·è®¤è¯
â”‚   â”œâ”€â”€ api/
â”‚   â”‚   â””â”€â”€ client.ts                # åç«¯ API è°ƒç”¨å°è£…
â”‚   â””â”€â”€ utils/
â”‚       â””â”€â”€ markdown.ts              # Markdown æ¸²æŸ“ + å¼•ç”¨è§£æ
â””â”€â”€ public/
```

**å…³é”®äº¤äº’æµç¨‹**ï¼š

1. **å·¥å…·è°ƒç”¨æˆæƒæµç¨‹**
   ```
   ç”¨æˆ·å‘é€æ¶ˆæ¯ 
     â†’ åç«¯è¿”å› {type: "tool_request", tool: "web_search", params: {...}}
     â†’ å‰ç«¯å¼¹å‡º ToolConsentDialog
     â†’ ç”¨æˆ·ç‚¹å‡»"å…è®¸" / "æ‹’ç»"
     â†’ å‘é€æˆæƒç»“æœåˆ°åç«¯
     â†’ ç»§ç»­æ‰§è¡Œæˆ–ç»ˆæ­¢
   ```

2. **å¼•ç”¨å±•ç¤ºæµç¨‹**
   ```
   LLM è¿”å›å¸¦å¼•ç”¨çš„æ–‡æœ¬: "æ ¹æ®èµ„æ–™æ˜¾ç¤º[1][2]..."
     â†’ å‰ç«¯è§£æ [1][2] æ ‡è®°
     â†’ ä»å“åº”çš„ citations å­—æ®µæå–æ¥æº
     â†’ æ¸²æŸ“ CitationCard (æ ‡é¢˜/URL/æ‘˜è¦)
     â†’ ç‚¹å‡»å¡ç‰‡å¯è·³è½¬åŸæ–‡
   ```

**UI æ”¹é€ è¦ç‚¹**ï¼š
- åœ¨ Open WebUI åŸºç¡€ä¸Šæ–°å¢ `ToolConsentDialog` ç»„ä»¶
- æ”¹é€  `MessageBubble` æ”¯æŒå¼•ç”¨å¡ç‰‡åµŒå…¥
- æ–°å¢ `/skills` è·¯ç”±é¡µé¢ç®¡ç†æŠ€èƒ½å¼€å…³

---

### 2.2 API ç½‘å…³ä¸ä¼šè¯å±‚ (apps/gateway)

**æŠ€æœ¯é€‰å‹**ï¼š**FastAPI** + **Redis**

**æ ¸å¿ƒèŒè´£**ï¼š
- ä¼šè¯ç®¡ç†ï¼ˆSession ID â†’ å¯¹è¯å†å²ï¼‰
- WebSocket è¿æ¥ç»´æŠ¤
- å·¥å…·è°ƒç”¨æƒé™æ‹¦æˆª
- é€Ÿç‡é™åˆ¶ï¼ˆæ¯åˆ†é’Ÿè¯·æ±‚æ•°ï¼‰

**ç›®å½•ç»“æ„**ï¼š
```
gateway/
â”œâ”€â”€ main.py                    # FastAPI å…¥å£
â”œâ”€â”€ routers/
â”‚   â”œâ”€â”€ chat.py                # /chat/stream èŠå¤©æ¥å£
â”‚   â”œâ”€â”€ skills.py              # /skills CRUD æ¥å£
â”‚   â””â”€â”€ auth.py                # ç”¨æˆ·è®¤è¯
â”œâ”€â”€ middleware/
â”‚   â”œâ”€â”€ session.py             # Redis ä¼šè¯ä¸­é—´ä»¶
â”‚   â”œâ”€â”€ rate_limit.py          # é€Ÿç‡é™åˆ¶
â”‚   â””â”€â”€ permission.py          # å·¥å…·æƒé™æ£€æŸ¥ â­
â”œâ”€â”€ models/
â”‚   â””â”€â”€ schemas.py             # Pydantic æ•°æ®æ¨¡å‹
â””â”€â”€ config.py                  # é…ç½®åŠ è½½
```

**å…³é”®æ¥å£è®¾è®¡**ï¼š

**1) POST /chat/stream**
```json
// è¯·æ±‚
{
  "session_id": "sess-abc123",
  "message": "å¸®æˆ‘æœç´¢æœ€æ–°çš„AIæ–°é—»",
  "stream": true
}

// å“åº” (SSE Stream)
data: {"type": "thinking", "content": "æ­£åœ¨åˆ†ææ‚¨çš„éœ€æ±‚..."}

data: {"type": "tool_request", "tool": "web_search", 
       "params": {"query": "AIæ–°é—»", "top_n": 5},
       "description": "æœç´¢ç™¾åº¦è·å–æœ€æ–°AIç›¸å…³æ–°é—»"}

// ç­‰å¾…å‰ç«¯æˆæƒ...

data: {"type": "tool_executing", "tool": "web_search"}

data: {"type": "chunk", "content": "æ ¹æ®æœç´¢ç»“æœ[1]..."}

data: {"type": "citations", "items": [
         {"id": 1, "title": "...", "url": "...", "snippet": "..."}
       ]}

data: {"type": "done"}
```

**2) GET /skills**
```json
{
  "skills": [
    {
      "id": "web_search",
      "name": "ç½‘é¡µæœç´¢",
      "enabled": true,
      "requires_consent": true,
      "mcp_server": "baidu-search"
    },
    {
      "id": "knowledge_query",
      "name": "çŸ¥è¯†åº“æŸ¥è¯¢",
      "enabled": true,
      "requires_consent": false,
      "mcp_server": "internal-kb"
    }
  ]
}
```

---

### 2.3 Agent ç¼–æ’å±‚ (apps/orchestrator)

**æŠ€æœ¯é€‰å‹**ï¼š**LangGraph** + **LangChain**

**æ ¸å¿ƒæµç¨‹å›¾**ï¼š

```
                    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                    â”‚  ç”¨æˆ·è¾“å…¥     â”‚
                    â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜
                           â”‚
                    â”Œâ”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”
                    â”‚ æ„å›¾è¯†åˆ«èŠ‚ç‚¹  â”‚
                    â”‚ (LLM åˆ†ç±»)   â”‚
                    â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜
                           â”‚
                â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                â”‚                     â”‚
         â”Œâ”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”      â”Œâ”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”
         â”‚ éœ€è¦æœç´¢?    â”‚      â”‚ éœ€è¦çŸ¥è¯†åº“?  â”‚
         â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”˜      â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”˜
                â”‚                     â”‚
         â”Œâ”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”      â”Œâ”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”
         â”‚ Skills é€‰æ‹©  â”‚      â”‚ RAG æ£€ç´¢    â”‚
         â”‚ â†’ web_searchâ”‚      â”‚ â†’ retrieve  â”‚
         â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”˜      â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”˜
                â”‚                     â”‚
         â”Œâ”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”      â”Œâ”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”
         â”‚ MCP å·¥å…·è°ƒç”¨ â”‚      â”‚ Rerank ç²¾æ’ â”‚
         â”‚ (éœ€æˆæƒ)     â”‚      â”‚ (Top 5)     â”‚
         â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”˜      â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”˜
                â”‚                     â”‚
                â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                           â”‚
                    â”Œâ”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”
                    â”‚ ä¸Šä¸‹æ–‡æ„å»º   â”‚
                    â”‚ (Prompt)    â”‚
                    â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜
                           â”‚
                    â”Œâ”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”
                    â”‚ LLM ç”Ÿæˆ     â”‚
                    â”‚ (å¸¦å¼•ç”¨)     â”‚
                    â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜
                           â”‚
                    â”Œâ”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”
                    â”‚ ç»“æœè¿”å›      â”‚
                    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

**ç›®å½•ç»“æ„**ï¼š
```
orchestrator/
â”œâ”€â”€ main.py                      # FastAPI æœåŠ¡å…¥å£
â”œâ”€â”€ graph/
â”‚   â”œâ”€â”€ agent_graph.py           # LangGraph å®šä¹‰ â­
â”‚   â”œâ”€â”€ nodes/
â”‚   â”‚   â”œâ”€â”€ intent_classifier.py # æ„å›¾è¯†åˆ«èŠ‚ç‚¹
â”‚   â”‚   â”œâ”€â”€ skill_selector.py    # æŠ€èƒ½é€‰æ‹©èŠ‚ç‚¹
â”‚   â”‚   â”œâ”€â”€ rag_retriever.py     # RAG æ£€ç´¢èŠ‚ç‚¹
â”‚   â”‚   â”œâ”€â”€ tool_executor.py     # MCP å·¥å…·æ‰§è¡ŒèŠ‚ç‚¹ â­
â”‚   â”‚   â””â”€â”€ llm_generator.py     # LLM ç”ŸæˆèŠ‚ç‚¹
â”‚   â””â”€â”€ state.py                 # AgentState å®šä¹‰
â”œâ”€â”€ services/
â”‚   â”œâ”€â”€ mcp_manager.py           # MCP å®¢æˆ·ç«¯ç®¡ç† â­
â”‚   â”œâ”€â”€ skill_registry.py        # æŠ€èƒ½ä»“åº“æœåŠ¡ â­
â”‚   â”œâ”€â”€ llm_client.py            # åœ¨çº¿ LLM API å°è£…
â”‚   â””â”€â”€ rag_pipeline.py          # RAG å®Œæ•´æµç¨‹
â””â”€â”€ config/
    â””â”€â”€ settings.py              # ç¯å¢ƒå˜é‡é…ç½®
```

**AgentState å®šä¹‰**ï¼š
```python
# state.py
from typing import TypedDict, List, Optional

class AgentState(TypedDict):
    # è¾“å…¥
    session_id: str
    user_message: str
    chat_history: List[dict]
    
    # ä¸­é—´çŠ¶æ€
    intent: str  # "search" | "knowledge" | "chat"
    selected_skill: Optional[str]
    tool_call_approved: bool
    
    # RAG ç›¸å…³
    retrieved_docs: List[dict]
    reranked_docs: List[dict]
    
    # å·¥å…·ç›¸å…³
    tool_results: Optional[dict]
    
    # è¾“å‡º
    final_answer: str
    citations: List[dict]
    metadata: dict
```

**LangGraph å›¾å®šä¹‰ä¼ªä»£ç **ï¼š
```python
# agent_graph.py
from langgraph.graph import StateGraph, END

def create_agent_graph():
    workflow = StateGraph(AgentState)
    
    # æ·»åŠ èŠ‚ç‚¹
    workflow.add_node("intent_classifier", classify_intent)
    workflow.add_node("skill_selector", select_skill)
    workflow.add_node("tool_executor", execute_tool)
    workflow.add_node("rag_retriever", retrieve_knowledge)
    workflow.add_node("reranker", rerank_results)
    workflow.add_node("llm_generator", generate_answer)
    
    # è®¾ç½®å…¥å£
    workflow.set_entry_point("intent_classifier")
    
    # æ·»åŠ æ¡ä»¶è¾¹
    workflow.add_conditional_edges(
        "intent_classifier",
        route_by_intent,
        {
            "search": "skill_selector",
            "knowledge": "rag_retriever",
            "chat": "llm_generator"
        }
    )
    
    workflow.add_edge("skill_selector", "tool_executor")
    workflow.add_conditional_edges(
        "tool_executor",
        check_approval,
        {
            "approved": "llm_generator",
            "rejected": END
        }
    )
    
    workflow.add_edge("rag_retriever", "reranker")
    workflow.add_edge("reranker", "llm_generator")
    workflow.add_edge("llm_generator", END)
    
    return workflow.compile()
```

---

### 2.4 MCP æ”¯æŒå±‚ (services/mcp-*)

**MCP Server å®ç°è§„èŒƒ**ï¼š

**ç›®å½•ç»“æ„**ï¼š
```
services/
â”œâ”€â”€ mcp-baidu-search/           # ç™¾åº¦æœç´¢ MCP Server â­
â”‚   â”œâ”€â”€ server.py               # MCP æœåŠ¡ä¸»ç¨‹åº
â”‚   â”œâ”€â”€ tools/
â”‚   â”‚   â”œâ”€â”€ search.py           # æœç´¢å·¥å…·å®ç°
â”‚   â”‚   â””â”€â”€ fetch.py            # ç½‘é¡µæŠ“å–å·¥å…·
â”‚   â”œâ”€â”€ requirements.txt
â”‚   â””â”€â”€ mcp.json                # MCP å…ƒæ•°æ®å£°æ˜
â”‚
â”œâ”€â”€ mcp-knowledge/              # å†…éƒ¨çŸ¥è¯†åº“ MCP Server
â”‚   â”œâ”€â”€ server.py
â”‚   â”œâ”€â”€ tools/
â”‚   â”‚   â””â”€â”€ query_kb.py
â”‚   â””â”€â”€ mcp.json
â”‚
â””â”€â”€ mcp-manager/                # MCP ç»Ÿä¸€ç®¡ç†æœåŠ¡
    â”œâ”€â”€ manager.py              # ç®¡ç†å¤šä¸ª MCP Server è¿æ¥
    â”œâ”€â”€ discovery.py            # è‡ªåŠ¨å‘ç°æœ¬åœ° MCP Server
    â””â”€â”€ client.py               # MCP å®¢æˆ·ç«¯å°è£…
```

**MCP Server ç¤ºä¾‹æ¡†æ¶** (mcp-baidu-search/server.py)ï¼š
```
åŸºäº MCP Python SDK å®ç°

æ ¸å¿ƒæ–¹æ³•ï¼š
1. list_tools() - è¿”å›å¯ç”¨å·¥å…·åˆ—è¡¨
   - search: æœç´¢ç™¾åº¦è·å–ç»“æœåˆ—è¡¨
   - fetch_page: æŠ“å–æŒ‡å®š URL çš„å®Œæ•´å†…å®¹

2. call_tool(name, arguments) - æ‰§è¡Œå·¥å…·
   - ä½¿ç”¨ Playwright æ— å¤´æµè§ˆå™¨
   - éµå®ˆ robots.txt
   - è¿”å›ç»“æ„åŒ–æ•°æ®

3. list_resources() - å¯é€‰ï¼Œæä¾›é™æ€èµ„æº
   - æœç´¢å†å²è®°å½•
   - å¸¸ç”¨ç½‘ç«™åˆ—è¡¨

å·¥å…·æè¿°ç¤ºä¾‹ï¼š
{
  "name": "search",
  "description": "åœ¨ç™¾åº¦æœç´¢å¼•æ“ä¸­æœç´¢å…³é”®è¯ï¼Œè¿”å›Top Nç»“æœ",
  "inputSchema": {
    "type": "object",
    "properties": {
      "query": {"type": "string", "description": "æœç´¢å…³é”®è¯"},
      "top_n": {"type": "integer", "default": 5}
    },
    "required": ["query"]
  }
}
```

**MCP Manager èŒè´£**ï¼š
```
mcp-manager/manager.py

åŠŸèƒ½ï¼š
1. å¯åŠ¨æ—¶è‡ªåŠ¨å‘ç°æ‰€æœ‰ MCP Server (è¯»å– services/*/mcp.json)
2. å»ºç«‹ JSON-RPC è¿æ¥ï¼ˆstdio æˆ– HTTPï¼‰
3. ç¼“å­˜å·¥å…·åˆ—è¡¨ï¼ˆå®šæœŸåˆ·æ–°ï¼‰
4. æä¾›ç»Ÿä¸€è°ƒç”¨æ¥å£ï¼š
   await mcp_manager.call_tool(
       server="baidu-search",
       tool="search",
       args={"query": "AIæ–°é—»", "top_n": 5},
       require_approval=True  # è§¦å‘å‰ç«¯æˆæƒæµç¨‹
   )
5. è®°å½•è°ƒç”¨æ—¥å¿—ï¼ˆå®¡è®¡ï¼‰
```

---

### 2.5 Skills Registry (services/skills-registry)

**â­ éµå¾ª Claude Skills å…¬å¼€è§„èŒƒ (2025-01-16)**

**æŠ€èƒ½å®šä¹‰æ ¼å¼** (ä¸¥æ ¼éµå¾ªå®˜æ–¹ JSON Schema)ï¼š

```json
// skills/web_search.json
{
  "name": "web_search",
  "title": "ç½‘é¡µæœç´¢",
  "description": "åœ¨ç™¾åº¦æœç´¢å¼•æ“ä¸­æœç´¢å…³é”®è¯å¹¶è·å–ç½‘é¡µå†…å®¹ï¼Œé€‚ç”¨äºéœ€è¦æœ€æ–°ä¿¡æ¯æˆ–å¤–éƒ¨äº‹å®éªŒè¯çš„åœºæ™¯",
  "version": "1.0.0",
  
  // Claude Skills å®˜æ–¹å­—æ®µ
  "category": "search",
  "subcategory": "web",
  "icon": "ğŸ”",
  "author": {
    "name": "System",
    "url": "https://example.com"
  },
  
  // æƒé™å’Œå®‰å…¨
  "authorization": {
    "type": "user_consent",
    "consent_message": "æ­¤æ“ä½œå°†è®¿é—®ç™¾åº¦æœç´¢å¹¶æŠ“å–ç½‘é¡µå†…å®¹ï¼Œæ˜¯å¦å…è®¸ï¼Ÿ",
    "scopes": ["read:web", "fetch:page"]
  },
  
  // Function Calling Schema (OpenAI Compatible)
  "function": {
    "name": "web_search",
    "description": "æœç´¢ç½‘é¡µå¹¶è¿”å›ç»“æ„åŒ–ç»“æœ",
    "parameters": {
      "type": "object",
      "properties": {
        "query": {
          "type": "string",
          "description": "æœç´¢å…³é”®è¯"
        },
        "top_n": {
          "type": "integer",
          "description": "è¿”å›ç»“æœæ•°é‡",
          "default": 5,
          "minimum": 1,
          "maximum": 10
        },
        "language": {
          "type": "string",
          "enum": ["zh-CN", "en"],
          "default": "zh-CN"
        }
      },
      "required": ["query"]
    }
  },
  
  // æ‰§è¡Œé…ç½®
  "execution": {
    "type": "mcp_tool",  // æˆ– "http_api", "function"
    "config": {
      "server": "baidu-search",
      "tool": "search",
      "timeout": 30000,
      "retry": 2
    }
  },
  
  // ç¤ºä¾‹å’Œæ–‡æ¡£
  "examples": [
    {
      "input": {
        "query": "2024å¹´AIå‘å±•è¶‹åŠ¿",
        "top_n": 3
      },
      "output": {
        "results": [
          {
            "title": "ç¤ºä¾‹æ ‡é¢˜",
            "url": "https://example.com",
            "snippet": "æ‘˜è¦å†…å®¹..."
          }
        ]
      },
      "description": "æœç´¢æœ€æ–°AIå‘å±•ä¿¡æ¯"
    }
  ],
  
  // å…ƒæ•°æ®
  "metadata": {
    "tags": ["search", "web", "china"],
    "cost_tier": "low",  // low, medium, high
    "rate_limit": "100/hour",
    "dependencies": ["playwright", "beautifulsoup4"]
  }
}
```

**Skills Registry æ¶æ„**ï¼š

```
services/skills-registry/
â”œâ”€â”€ api/
â”‚   â”œâ”€â”€ main.py                    # FastAPI æœåŠ¡
â”‚   â”œâ”€â”€ routers/
â”‚   â”‚   â”œâ”€â”€ skills.py              # Skills CRUD API
â”‚   â”‚   â”œâ”€â”€ marketplace.py         # Skills å¸‚åœºï¼ˆå‘ç°/å®‰è£…ï¼‰â­
â”‚   â”‚   â””â”€â”€ execution.py           # Skills æ‰§è¡Œ API
â”‚   â””â”€â”€ middleware/
â”‚       â”œâ”€â”€ validator.py           # JSON Schema éªŒè¯å™¨
â”‚       â””â”€â”€ sandbox.py             # Skills æ²™ç®±éš”ç¦»
â”œâ”€â”€ storage/
â”‚   â”œâ”€â”€ db.py                      # SQLite/PostgreSQL å­˜å‚¨
â”‚   â”œâ”€â”€ skills/                    # æœ¬åœ° Skills JSON æ–‡ä»¶
â”‚   â”‚   â”œâ”€â”€ web_search.json
â”‚   â”‚   â”œâ”€â”€ knowledge_query.json
â”‚   â”‚   â””â”€â”€ ...
â”‚   â””â”€â”€ cache/                     # Skills æ‰§è¡Œç¼“å­˜
â”œâ”€â”€ executor/
â”‚   â”œâ”€â”€ dispatcher.py              # æ ¹æ® execution.type åˆ†å‘
â”‚   â”œâ”€â”€ mcp_executor.py            # MCP å·¥å…·æ‰§è¡Œå™¨
â”‚   â”œâ”€â”€ http_executor.py           # HTTP API æ‰§è¡Œå™¨
â”‚   â””â”€â”€ function_executor.py       # Python å‡½æ•°æ‰§è¡Œå™¨
â”œâ”€â”€ marketplace/
â”‚   â”œâ”€â”€ client.py                  # è¿æ¥å¤–éƒ¨ Skills å¸‚åœº â­
â”‚   â”œâ”€â”€ installer.py               # åŠ¨æ€å®‰è£… Skills
â”‚   â””â”€â”€ registry.json              # å·²çŸ¥ Skills å¸‚åœºåˆ—è¡¨
â””â”€â”€ schema/
    â””â”€â”€ skill_schema.json          # Claude Skills JSON Schema
```

**åŠ¨æ€æ·»åŠ  Skills æµç¨‹**ï¼š

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚               ç”¨æˆ·æ“ä½œï¼šæ·»åŠ æ–° Skill                      â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                     â”‚
        â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
        â”‚                         â”‚
â”Œâ”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”       â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ æ–¹å¼1: æœ¬åœ°ä¸Šä¼  â”‚       â”‚ æ–¹å¼2: å¸‚åœºå®‰è£…  â”‚
â”‚ (JSON æ–‡ä»¶)    â”‚       â”‚ (URL/ID)        â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”˜       â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”˜
        â”‚                         â”‚
        â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                     â”‚
              â”Œâ”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”
              â”‚ JSON Schema â”‚
              â”‚ éªŒè¯         â”‚
              â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”˜
                     â”‚ (é€šè¿‡)
              â”Œâ”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”
              â”‚ å®‰å…¨æ£€æŸ¥     â”‚
              â”‚ - æƒé™èŒƒå›´   â”‚
              â”‚ - ä¾èµ–æ£€æµ‹   â”‚
              â”‚ - æ²™ç®±é…ç½®   â”‚
              â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”˜
                     â”‚ (é€šè¿‡)
              â”Œâ”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”
              â”‚ å­˜å‚¨åˆ° DB    â”‚
              â”‚ + æ–‡ä»¶ç³»ç»Ÿ   â”‚
              â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”˜
                     â”‚
              â”Œâ”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”
              â”‚ åˆå§‹åŒ–æ‰§è¡Œå™¨ â”‚
              â”‚ (æ ¹æ® type) â”‚
              â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”˜
                     â”‚
              â”Œâ”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”
              â”‚ æ³¨å†Œåˆ°       â”‚
              â”‚ Orchestrator â”‚
              â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

**Skills Registry API (RESTful)**ï¼š

```http
### 1. è·å–æ‰€æœ‰ Skills
GET /api/v1/skills
Response:
{
  "skills": [
    {
      "id": "skill-001",
      "name": "web_search",
      "title": "ç½‘é¡µæœç´¢",
      "version": "1.0.0",
      "enabled": true,
      "category": "search",
      "icon": "ğŸ”"
    }
  ],
  "total": 10
}

### 2. è·å– Skill è¯¦æƒ…
GET /api/v1/skills/{skill_id}
Response:
{
  "id": "skill-001",
  "name": "web_search",
  "title": "ç½‘é¡µæœç´¢",
  "description": "...",
  "function": { ... },
  "execution": { ... },
  "examples": [ ... ],
  "metadata": { ... },
  "stats": {
    "total_calls": 1234,
    "success_rate": 0.98,
    "avg_latency_ms": 450
  }
}

### 3. åŠ¨æ€æ·»åŠ  Skill (æœ¬åœ°ä¸Šä¼ )
POST /api/v1/skills
Content-Type: application/json

{
  "name": "custom_api",
  "title": "è‡ªå®šä¹‰ API è°ƒç”¨",
  "description": "...",
  "function": { ... },
  "execution": {
    "type": "http_api",
    "config": {
      "url": "https://api.example.com/v1/query",
      "method": "POST",
      "headers": {
        "Authorization": "Bearer ${API_KEY}"
      }
    }
  }
}

Response:
{
  "id": "skill-011",
  "name": "custom_api",
  "status": "installed",
  "validation": {
    "schema": "passed",
    "security": "passed"
  }
}

### 4. ä»å¸‚åœºå®‰è£… Skill
POST /api/v1/skills/install
{
  "source": "marketplace",
  "skill_id": "community/weather-forecast",
  "marketplace_url": "https://skills.anthropic.com"
}

Response:
{
  "id": "skill-012",
  "name": "weather_forecast",
  "status": "installed",
  "dependencies_installed": ["requests", "pydantic"]
}

### 5. å¯ç”¨/ç¦ç”¨ Skill
PATCH /api/v1/skills/{skill_id}
{
  "enabled": false
}

### 6. åˆ é™¤ Skill
DELETE /api/v1/skills/{skill_id}

### 7. æ‰§è¡Œ Skill (ç›´æ¥æµ‹è¯•)
POST /api/v1/skills/{skill_id}/execute
{
  "parameters": {
    "query": "æµ‹è¯•æŸ¥è¯¢",
    "top_n": 3
  }
}

Response:
{
  "status": "success",
  "result": { ... },
  "execution_time_ms": 450,
  "metadata": {
    "tool_used": "baidu-search.search",
    "cache_hit": false
  }
}
```

**Skills Marketplace é›†æˆ**ï¼š

```python
# marketplace/client.py

class SkillsMarketplaceClient:
    """
    è¿æ¥å¤–éƒ¨ Skills å¸‚åœºï¼ˆå¦‚ Anthropic Skills Hubï¼‰
    """
    
    def __init__(self, registry_urls: List[str]):
        self.registries = registry_urls
        # ä¾‹å¦‚: ["https://skills.anthropic.com/api/v1"]
    
    async def search(self, query: str, category: str = None):
        """
        æœç´¢å¸‚åœºä¸­çš„ Skills
        
        è¿”å›:
        [
          {
            "id": "community/weather-forecast",
            "name": "weather_forecast",
            "title": "Weather Forecast",
            "description": "...",
            "downloads": 1234,
            "rating": 4.5,
            "verified": true
          }
        ]
        """
        pass
    
    async def get_skill(self, skill_id: str):
        """è·å– Skill å®Œæ•´å®šä¹‰ï¼ˆJSONï¼‰"""
        pass
    
    async def install(self, skill_id: str):
        """
        ä¸‹è½½å¹¶å®‰è£… Skill
        
        æµç¨‹:
        1. ä¸‹è½½ JSON å®šä¹‰
        2. éªŒè¯ Schema
        3. ä¸‹è½½ä¾èµ–ï¼ˆå¦‚éœ€è¦ï¼‰
        4. ä¿å­˜åˆ°æœ¬åœ°
        5. æ³¨å†Œåˆ°ç³»ç»Ÿ
        """
        pass
```

**Skills æ‰§è¡Œè°ƒåº¦å™¨**ï¼š

```python
# executor/dispatcher.py

class SkillExecutor:
    """
    æ ¹æ® Skill çš„ execution.type åŠ¨æ€åˆ†å‘æ‰§è¡Œ
    """
    
    def __init__(self):
        self.executors = {
            "mcp_tool": MCPToolExecutor(),
            "http_api": HTTPAPIExecutor(),
            "function": PythonFunctionExecutor(),
            "script": ScriptExecutor()  # æ‰§è¡Œæ²™ç®±è„šæœ¬
        }
    
    async def execute(self, skill: dict, parameters: dict):
        """
        æ‰§è¡Œ Skill
        
        å‚æ•°:
        - skill: å®Œæ•´çš„ Skill JSON å®šä¹‰
        - parameters: ç”¨æˆ·æä¾›çš„å‚æ•°ï¼ˆå·²éªŒè¯ï¼‰
        
        è¿”å›:
        {
          "status": "success" | "error",
          "result": {...},
          "execution_time_ms": 450,
          "metadata": {...}
        }
        """
        exec_type = skill["execution"]["type"]
        config = skill["execution"]["config"]
        
        executor = self.executors.get(exec_type)
        if not executor:
            raise ValueError(f"Unsupported execution type: {exec_type}")
        
        return await executor.run(config, parameters)
```

**é›†æˆåˆ° LangGraph Orchestrator**ï¼š

```python
# orchestrator/graph/nodes/skill_executor.py

async def execute_skill_node(state: AgentState):
    """
    Skill æ‰§è¡ŒèŠ‚ç‚¹ï¼ˆåœ¨ LangGraph ä¸­ï¼‰
    """
    skill_id = state["selected_skill"]
    parameters = state["skill_parameters"]
    
    # 1. ä» Registry è·å– Skill å®šä¹‰
    skill = await skills_registry.get_skill(skill_id)
    
    # 2. æ£€æŸ¥æ˜¯å¦éœ€è¦ç”¨æˆ·æˆæƒ
    if skill["authorization"]["type"] == "user_consent":
        state["requires_approval"] = True
        state["approval_message"] = skill["authorization"]["consent_message"]
        return state  # ç­‰å¾…å‰ç«¯æˆæƒ
    
    # 3. æ‰§è¡Œ Skill
    result = await skill_executor.execute(skill, parameters)
    
    # 4. æ›´æ–°çŠ¶æ€
    state["tool_results"] = result
    state["citations"].extend(result.get("citations", []))
    
    return state
```

---

### 2.6 RAG å¤„ç†ç®¡çº¿ (services/rag-pipeline)

**å®Œæ•´æµç¨‹æ¶æ„**ï¼š

```
æ–‡æ¡£å…¥åº“æµç¨‹ï¼š
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ æ–‡æ¡£åŠ è½½  â”‚â”€â”€â†’â”‚ ä¸­æ–‡åˆ†å—  â”‚â”€â”€â†’â”‚ åµŒå…¥API   â”‚â”€â”€â†’â”‚ Milvus   â”‚
â”‚ (PDF/MD) â”‚   â”‚(Parent-  â”‚   â”‚(Cohere/  â”‚   â”‚ ç´¢å¼•     â”‚
â”‚          â”‚   â”‚ Child)   â”‚   â”‚ Jina)    â”‚   â”‚          â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

æŸ¥è¯¢æµç¨‹ï¼š
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ ç”¨æˆ·é—®é¢˜  â”‚â”€â”€â†’â”‚ æŸ¥è¯¢åµŒå…¥  â”‚â”€â”€â†’â”‚ å‘é‡æ£€ç´¢  â”‚â”€â”€â†’â”‚ BM25æ£€ç´¢  â”‚
â”‚          â”‚   â”‚ (API)    â”‚   â”‚ (Top50)  â”‚   â”‚ (Top50)  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                      â”‚              â”‚
                                      â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜
                                             â”‚
                                      â”Œâ”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”
                                      â”‚ æ··åˆèåˆ      â”‚
                                      â”‚ (RRF/æƒé‡)   â”‚
                                      â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜
                                             â”‚
                                      â”Œâ”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”
                                      â”‚ Rerank API   â”‚
                                      â”‚ (Cohere/Jina)â”‚
                                      â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜
                                             â”‚
                                      â”Œâ”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”
                                      â”‚ Top 5 è¿”å›   â”‚
                                      â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

**ç›®å½•ç»“æ„**ï¼š
```
rag-pipeline/
â”œâ”€â”€ loader/
â”‚   â”œâ”€â”€ pdf_loader.py          # PDF åŠ è½½ï¼ˆPyPDF2/pdfplumberï¼‰
â”‚   â”œâ”€â”€ markdown_loader.py     # Markdown åŠ è½½
â”‚   â””â”€â”€ web_loader.py          # ç½‘é¡µå†…å®¹åŠ è½½
â”œâ”€â”€ chunker/
â”‚   â”œâ”€â”€ chinese_splitter.py    # ä¸­æ–‡å‹å¥½åˆ†å—å™¨ â­
â”‚   â””â”€â”€ parent_child.py        # Parent-Child åˆ†å—ç­–ç•¥
â”œâ”€â”€ embedder/
â”‚   â”œâ”€â”€ cohere_embedder.py     # Cohere Embed v4
â”‚   â””â”€â”€ jina_embedder.py       # Jina Embeddings v3
â”œâ”€â”€ indexer/
â”‚   â”œâ”€â”€ milvus_client.py       # Milvus æ“ä½œå°è£…
â”‚   â””â”€â”€ collection_manager.py  # Collection ç®¡ç†
â”œâ”€â”€ retriever/
â”‚   â”œâ”€â”€ hybrid_retriever.py    # æ··åˆæ£€ç´¢ â­
â”‚   â””â”€â”€ metadata_filter.py     # å…ƒæ•°æ®è¿‡æ»¤
â”œâ”€â”€ reranker/
â”‚   â”œâ”€â”€ cohere_reranker.py     # Cohere Rerank v4
â”‚   â””â”€â”€ jina_reranker.py       # Jina Reranker v2
â””â”€â”€ pipeline.py                # ç»Ÿä¸€ç®¡çº¿å…¥å£
```

**å…³é”®é…ç½®**ï¼š

```yaml
# config/rag_config.yaml

# åˆ†å—ç­–ç•¥
chunking:
  strategy: parent_child
  parent:
    size: 1000          # å­—ç¬¦æ•°
    overlap: 200
  child:
    size: 300
    overlap: 100
  separators:           # ä¸­æ–‡å‹å¥½åˆ†éš”ç¬¦
    - "\n\n"
    - "\n"
    - "ã€‚"
    - "ï¼"
    - "ï¼Ÿ"
    - "ï¼›"
    - "ï¼Œ"

# åµŒå…¥æœåŠ¡ï¼ˆåœ¨çº¿ APIï¼‰
embedding:
  provider: cohere      # æˆ– jina
  model: embed-multilingual-v4.0
  dimensions: 1024
  api_key: ${COHERE_API_KEY}
  batch_size: 96
  rate_limit: 100/min

# å‘é‡æ•°æ®åº“
vector_store:
  type: milvus
  host: localhost
  port: 19530
  collection: knowledge_base
  index:
    type: HNSW
    metric: COSINE
    params:
      M: 32
      efConstruction: 200
  
# æ£€ç´¢ç­–ç•¥
retrieval:
  hybrid_mode: true
  vector:
    top_k: 50
    score_threshold: 0.3
  bm25:
    top_k: 50
    k1: 1.5
    b: 0.75
  fusion:
    method: rrf         # Reciprocal Rank Fusion
    k: 60

# é‡æ’æœåŠ¡ï¼ˆåœ¨çº¿ APIï¼‰
reranking:
  provider: cohere      # æˆ– jina
  model: rerank-v4.0
  top_n: 5
  api_key: ${COHERE_API_KEY}
  score_threshold: 0.6
```

**ä¸­æ–‡åˆ†å—å™¨å®ç°è¦ç‚¹**ï¼š
```
chinese_splitter.py

æ ¸å¿ƒé€»è¾‘ï¼š
1. ä¼˜å…ˆæŒ‰æ®µè½åˆ†å‰²ï¼ˆ\n\nï¼‰
2. æ®µè½è¿‡é•¿æ—¶æŒ‰å¥å­åˆ†å‰²ï¼ˆã€‚ï¼ï¼Ÿï¼‰
3. å¥å­è¿‡é•¿æ—¶æŒ‰é€—å·åˆ†å‰²ï¼ˆï¼Œï¼›ï¼‰
4. ä¿æŒè¯­ä¹‰å®Œæ•´æ€§ï¼š
   - å¼•å·å†…å®¹ä¸æ‹†åˆ†
   - åˆ—è¡¨é¡¹ä¸æ‹†åˆ†
   - ä»£ç å—ä¸æ‹†åˆ†
5. æ·»åŠ é‡å åŒºåŸŸï¼ˆoverlapï¼‰ä¿æŒä¸Šä¸‹æ–‡è¿ç»­æ€§

ç‰¹æ®Šå¤„ç†ï¼š
- è¯†åˆ«ä¸­è‹±æ–‡æ··åˆå†…å®¹
- ä¿ç•™ Markdown æ ¼å¼æ ‡è®°
- è®°å½• Parent-Child å…³ç³»ï¼ˆç”¨äºæ£€ç´¢åå›æº¯ï¼‰
```

**Hybrid æ£€ç´¢èåˆç®—æ³•**ï¼š
```
Reciprocal Rank Fusion (RRF)

å…¬å¼ï¼š
RRF_score(doc) = Î£ 1 / (k + rank_in_result_i)

å…¶ä¸­ï¼š
- k = 60 (å¸¸æ•°)
- rank_in_result_i æ˜¯æ–‡æ¡£åœ¨ç¬¬ i ä¸ªæ£€ç´¢ç»“æœä¸­çš„æ’å